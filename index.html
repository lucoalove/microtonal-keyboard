<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Microtonal Keyboard</title>
    <script src="https://unpkg.com/tone@15.0.4/build/Tone.js"></script>

    <style>
        body { font-family: sans-serif; }
    </style>
    
    <script>

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        var activeTones = [];
        var daw;
        
        function initDaw() {

            daw = document.getElementById("daw");

            daw.addEventListener("click", function(event) {
                // event.clientX - daw.clientX
                // repaintDaw();
            });
        }

        async function repaintDaw() {

            if (!daw.getContext) { return; }
            const ctx = daw.getContext("2d");

            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, daw.width, daw.height);

            // https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial
            
            activeTones.forEach((item, index) => {

                if (!item) { return; }
                
                ctx.fillStyle = "hsl(" + (index*360/17) + ", 100%, 50%)";
                ctx.fillRect(0, index * 10, 4, 8);
            });
        }
        
        function startTone(degree) {

            const oscillator = new OscillatorNode(audioContext, {
                type: "sine" // sine, square, triangle, sawtooth
            });
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 220 * Math.pow(2, degree/17.0);

            activeTones[degree] = [ oscillator, gainNode ];

            
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.02);
            oscillator.start(audioContext.currentTime);

            repaintDaw();
        }

        function stopTone(degree) {

            const oscillator = activeTones[degree][0];
            const gainNode = activeTones[degree][1];
            
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            oscillator.stop(audioContext.currentTime + 0.3);

            activeTones[degree] = null;

            repaintDaw();
        }

        document.addEventListener("keydown", function(event) {

            if (event.repeat != undefined && event.repeat) { return; }
                
            switch (event.key) {
                case "a": startTone(0); break;
                    case "2": startTone(1); break;
                    case "w": startTone(2); break;
                case "s": startTone(3); break;
                    case "3": startTone(4); break;
                    case "e": startTone(5); break;
                case "d": startTone(6); break;
                case "f": startTone(7); break;
                    case "5": startTone(8); break;
                    case "t": startTone(9); break;
                case "g": startTone(10); break;
                    case "6": startTone(11); break;
                    case "y": startTone(12); break;
                case "h": startTone(13); break;
                    case "7": startTone(14); break;
                    case "u": startTone(15); break;
                case "j": startTone(16); break;
                case "k": startTone(17); break;
            }
        });

        document.addEventListener("keyup", function(event) {
                
            switch (event.key) {
                case "a": stopTone(0); break;
                    case "2": stopTone(1); break;
                    case "w": stopTone(2); break;
                case "s": stopTone(3); break;
                    case "3": stopTone(4); break;
                    case "e": stopTone(5); break;
                case "d": stopTone(6); break;
                case "f": stopTone(7); break;
                    case "5": stopTone(8); break;
                    case "t": stopTone(9); break;
                case "g": stopTone(10); break;
                    case "6": stopTone(11); break;
                    case "y": stopTone(12); break;
                case "h": stopTone(13); break;
                    case "7": stopTone(14); break;
                    case "u": stopTone(15); break;
                case "j": stopTone(16); break;
                case "k": stopTone(17); break;
            }
        });
    </script>
</head>

<body onload="initDaw();">

    <a href="https://github.com/lucoalove/microtonal-keyboard/">repo</a>

    <canvas id="daw" width="300" height="300">
        Your browser does not support canvas elements :(
    </canvas>

    use keybort

</body>

</html>
